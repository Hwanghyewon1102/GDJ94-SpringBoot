<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.winter.app.product.ProductDAO">

  <sql id="search">
   		 <if test="kind == 'k1'">
			WHERE  products_name LIKE concat('%', #{search}, '%')
		</if>
		<if test="kind == 'k2'">
			WHERE  products_contents LIKE concat('%', #{search}, '%')
		</if>
		<if test="kind == 'k3'">
			WHERE  products_category LIKE concat('%', #{search}, '%')
		</if>
    </sql>

    <!-- 리스트 -->
     <select id="list" resultType="ProductDTO" parameterType="ProductDTO">
    	SELECT * FROM products
    	<include refid="search"></include>
    	ORDER BY products_num DESC
		LIMIT #{startNum}, #{perPage}
    </select>

    <!-- 상세 조회 -->
    <select id="detail" parameterType="ProductDTO" resultType="ProductDTO">
        SELECT * 
        FROM products 
        WHERE products_num = #{productNum}
    </select>

    <!-- 추가 -->
    <insert id="add" parameterType="ProductDTO">
        INSERT INTO products 
        (products_name, products_contents, products_category, products_rate, products_sale)
        VALUES
        (#{productName}, #{productContents}, #{productCategory}, #{productRate}, #{productSale})
    </insert>

    <!-- 삭제 -->
    <delete id="delete" parameterType="ProductDTO">
        DELETE FROM products
        WHERE products_num = #{productNum}
    </delete>

    <!-- 수정 -->
    <update id="update" parameterType="ProductDTO">
        UPDATE products SET 
            products_name     = #{productName},
            products_category = #{productCategory},
            products_rate     = #{productRate},
            products_contents = #{productContents},
            products_sale     = #{productSale}
        WHERE products_num = #{productNum}
    </update>


    <!-- 댓글 목록 -->
    <select id="commentList" resultType="ProductCommentDTO" parameterType="java.util.Map">
        SELECT *
        FROM comment
        WHERE products_num = #{product.productNum}
        ORDER BY board_num DESC
        LIMIT #{pager.startNum}, #{pager.perPage}
    </select>

    <!-- 댓글 개수 -->
    <select id="commentCount" parameterType="ProductCommentDTO" resultType="Long">
        SELECT COUNT(board_num)
        FROM comment
        WHERE products_num = #{productNum}
    </select>

    <!-- 댓글 추가 -->
    <insert id="commentAdd" parameterType="ProductCommentDTO">
        INSERT INTO comment 
        VALUES (NULL, #{boardContents}, NOW(), #{productNum}, #{username})
    </insert>
    
    
        <select id="count" resultType="Long">
		SELECT count(products_num)
		FROM products	
		<include refid="search"></include>
	</select>

</mapper>
